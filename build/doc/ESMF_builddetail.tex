%  $Id: ESMF_builddetail.tex,v 1.2 2003/08/27 23:09:54 flanigan Exp $


\subsection{Make System}
\label{sec:make}
For most users the description of the build system in previous
sections should be sufficient.  Some users, however, may wish to have a
more detailed knowledge of the make system that is used by the library
either for configuring different build options or other reasons.
\subsubsection{General Structure}

The ESMF build system is broken into two parts.  The first is the
series of makefiles located with the source code.  The second is a set
of makefile fragements files designed to be used by the source code
makefiles.  Makefile fragment files are files that contain makefile
syntax defining build rules and actions, but do not constitute a
complete build system.

The main components of the make system are:
\begin{itemize}
\item{{\bf Build directories}}

There are two directories containing makefile fragment files used by
the make system.  

The {\tt build} directory contains a generic makefile fragment file
common.mk that is included by the top level Makefile in the source
tree.  common.mk contains generic build system settings and build
rules used across all platforms.  A user should have no reason to edit
common.mk.

The {\tt build\_config} directory contains makefile fragments for each
supported platform defining compilers, compiler flags, and the various
other definitions that are necessary to build on each platform.  Files
can also be added to this directory for specific machines where the
build settings are different from the standards of the architecture.
One of the files in this directory will be included by the
build/common.mk file depending the values of the environment variable
EMSF\_ARCH and ESMF\_SITE.  See below for more details on environment
variables.

\item{{\bf Environment Variables}}

The three sets of source code that the build system support all need
environment variables set to point to their top level source code
directories. 

\begin{description}

\item{ESMF Library} 

To build the ESMF library, ESMF\_DIR set to the top level ESMF
library source code directory.

\item{Implementation Report} 

The build system needs ESMF\_IMPL\_DIR set to the top level source
code directory of the Implementation Report source tree to build the
report and to build and run the examples.

\item{EVA Applications} 

An EVA source code tree does not contain a copy of the ESMF build
system.  Instead it uses a copy found in an ESMF library source code
tree.  Building the EVA applications requires that ESMF\_EVA\_DIR and
ESMF\_DIR be set.  ESMF\_EVA\_DIR has to be set to the top directory
of the EVA source code.  ESMF\_DIR has to be set to the top directory
of an ESMF source code tree.

\end{description}

There are four other variables that the build system uses.  If they
are not set, then the build system will assign default values to
them.  In most cases the default values will be fine.

\begin{description}

\item{ESMF\_ARCH} 

Defines current architecture. Default value is value returned by the
command uname -s.  There should be almost no reason for ESMF\_ARCH to
be set by a user.

\item{ESMF\_SITE}

If ESMF\_SITE is not set or has the value of default, default build
settings for the current machine architecture will be used.  Values
are created either from a machine's name or the compiler's name that
is used. In some cases both a machine's name and the compiler's name
will be used.  Example ESMF\_SITE values could be blackforest or
jazz\_lahey.

\item{ESMF\_PREC}

Variable specifying the precession build arguments.  Value can be 32
or 64.  When possible the default value will be 64, otherwise it will
be 32.

\item{ESMF\_BOPT} 

Variable specifying that the build system use either debugging or
optimization options.  Value of g specifies the debugging options.
Value of O (capital oh) specifies optimization options.  Default value
is O.

\end{description}


\item{{\bf Makefiles}}

Every source tree contains a Makefile in its top level directory.  This
makefile includes the common.mk file from the {\tt build} directory.
The top level makefile contains makefile settings specific for the
source code that it is found in.

Each directory in the source tree contains a Makefile which includes
the top level makefile.  These local Makefiles include defintions that
allow the local files and documents to be built.
\end{itemize}

\subsubsection{Build Configuration}

A single makefile or makefile fragment from the build system never
constitutes a complete set of build rules and settings.  Starting from
the local makefile, successive include commands are used to string
together makefiles and makefile fragments to create a complete system
of build rules and settings.  Configuration of the build system is
done by including a configuration makefile fragment.  The build
system can be configured for a machine's architecture or, if needed,
for a particular machine and its compiler. A configuration for a
specific machine or compiler is referred to as a site configuration.

The string of files included is fairly short.  Makefiles below the top
level makefile include the top level makefile. The top level makefile
includes build/common.mk and then build/common.mk includes a
configuration file from the build\_config directory.  The configuration
files in the build\_config directory contain the architecture and site
specific build settings.  The architecture and site that a file
configures is determined by its name.  The configuration makefile
fragments follow this naming convention:

\begin{verbatim}
    ESMF_ARCH.ESMF_SITE.mk
\end{verbatim}

Where ESMF\_ARCH and ESMF\_SITE are environment variables either set by
the user or given defalut values by the build system. ESMF\_ARCH is the
current architecture and will have the value returned by the command
uname -s.  ESMF\_SITE is the current machine or compiler name. If there
are no site specific files for a particular architecture, then
ESMF\_SITE will be set to default.  Examples:

\begin{verbatim}
    AIX.default.mk      ! Default configuation for RS6000.
    Linux.lahey.mk      ! Linux configuation using lahey compilers.
\end{verbatim}

\subsubsection{Source Code Configuration}

C++ and C source code written to build on a range of platforms many
times require preprocessor directives to configure the source code for
specific platforms.  The directives are included in the source code
and are processed by the C preprocessor (cpp) before the source code
is compiled.  The directives are used to determine among other things,
the memory requirements of variable types and the system resources
that are available.

The ESMF build system provides preprossor directives in conf.h files
that are included in the source code.  The path to the conf.h files is

\begin{verbatim}
    build_config/conf/ESMF_ARCH.ESMF_PREC.ESMF_SITE/conf.h
\end{verbatim}

Where ESMF\_ARCH, ESMF\_PREC arnd ESMF\_SITE are environment variables 
set by the user or given default values be the build system.  Based on 
the settings of these environment variables, the build system provides
a path to the correct conf.h file during source code compiles.

