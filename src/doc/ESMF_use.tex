% $Id: ESMF_use.tex,v 1.8 2003/08/28 17:14:37 flanigan Exp $

\subsection{Using the ESMF}
\label{UsingLibrary}

To use ESMF from Fortran, add the directory that contains
the ESMF {\tt *.mod} file(s),

\begin{verbatim}
$ESMF_DIR/mod/mod$ESMF_BOPT/$ESMF_ARCH.$ESMF_PREC.$ESMF_SITE
\end{verbatim} 

to your search path for {\tt *.mod} files.  For most compilers this path 
is identified either with a {\tt -I} or a {\tt -M}.  You must also link 
with the ESMF shared object library.  This is a file called 
{\tt libesmf.so} that is located in the following directory:

\begin{verbatim}
$ESMF_DIR/lib/lib$ESMF_BOPT/$ESMF_ARCH.$ESMF_PREC.$ESMF_SITE
\end{verbatim} 

The details of how to link on specific platforms are included in the 
next section.

There is a single ESMF module, called {\tt ESMF\_Mod}, that should be 
included in applications with the Fortran {\tt USE} statement.  It 
is not necessary to include any header files in Fortran.

To use ESMF from C/C++, link with the ESMF shared object library 
and include the {\tt ESMC.h} file. 

If you prefer standard libraries, a {\tt *.a} file is provided  
in the same library directory as the shared object file.  

\subsubsection{Shared Object Libraries and Linking}

Shared object libraries are libraries that are loaded by the first program 
that uses them. All programs that start afterwards automatically use the 
existing shared library. The library is kept in memory as long as any 
active program is still using it. 

Since shared object libraries are pre-linked to system libraries, using them
simplifies life for the user when a variety of system libraries are
required or when system libraries vary a great deal on a 
platform-to-platform basis.  ESMF requires linking to both Fortran90 and
C++ libraries on a set of very non-standardized platforms, and using
shared objects helps to hide some of this complexity.

The order in which shared libraries are presented to 
the linker is important. Library routines must be called before they are 
defined. So, if a library {\bf A} uses functionality provided by library 
{\bf B}, then library {\bf A} must appear before library {\bf B} on the link line. 

The following example shows how to link a Fortran90 
application with the ESMF shared library on a variety of platforms.  
In the example, the Fortran90 application is called {\tt myModel}.

\noindent We first define the following:

\begin{verbatim}
MODDIR = ${ESMF_DIR}/mod/mod${ESMF_BOPT}/${ESMF_ARCH}.${ESMF_PREC}.${ESMF_SITE}
LIBDIR = ${ESMF_DIR}/lib/lib${ESMF_BOPT}/${ESMF_ARCH}.${ESMF_PREC}.${ESMF_SITE}
\end{verbatim}

\noindent{\it Linking using the SGI with 64-bit addressing:} 

\begin{verbatim}
   f90 -freeform -64 -I${MODDIR} myModel.F  \
   -L${LIBDIR}  -rpath ${LIBDIR} -lesmf -lC -lCio -lmpi -lmpi++ -o myModel  
\end{verbatim}

\noindent{\it Linking using the IBM with 64-bit addressing:}

\begin{verbatim}
   xlf90_r -q64 -qsuffix=f=F90 -I${MODDIR} myModel.F -brtl \
   -L${LIBDIR}  -lesmf -lC -o myModel
\end{verbatim}

\noindent{\it Linking using the IBM with 32-bit addressing:}

\begin{verbatim}
   xlf90_r -qsuffix=f=F90 -I${MODDIR} myModel.F \
   -L${LIBDIR} -lesmf -brtl -lC -o myModel
\end{verbatim}

\noindent{\it Linking using the Compaq with 64-bit addressing:} 

\begin{verbatim}
   f90 -free -I${MODDIR} myModel.F \
   -L${LIBDIR} -rpath ${LIBDIR}  -lesmf  -lcxx -lmpi -o myModel
\end{verbatim}








