% $Id: ESMF_shareobj.tex,v 1.1 2003/03/17 21:15:57 btwomack Exp $

\subsection{Shared Objects}

\subsubsection{What is a Shared Object?}

In simplest terms a shared object is a type of UNIX software library. Under Linux it is also know as a shared library. There are three main types of software libraries for the UNIX operating system:

Shared object libraries -- are libraries that are loaded by the first program that uses it. All programs that start afterwards automatically use the existing shared library. The library is kept in memory as long as any active program is still using it. Using shared libraries you can: 
\begin{itemize}
\item update libraries and still support programs that want to use older, non-backward-compatible versions of those libraries;
\item override specific libraries or even specific functions in a library when executing a particular program.
\item do all this while programs are running using existing libraries.
\end{itemize}

Shared objects libraries have two different names: the \emph{soname} and the \emph{real name}. The \emph{soname} consists of the prefix \emph{"lib"}, followed by the name of the library, a \emph{".so"} followed by another dot, and a number indicating the major version number. The \emph{soname} may be fully qualified by prefixing path information. The \emph{real name} is the actual file name containing the compiled code for the library. The real name adds a dot, a minor number, another dot, and the release number, to the \emph{soname}. (The release number and the associated dot are optional.)

Statically linked libraries -- are linked together with the main application into a single executable image at compile time. The size of the final executable can become quite large and the entire application image, including all libraries, is loaded into memory at the start of execution. Static libraries generally start with the letters \emph{lib}, and have the extension \emph{.a}

Dynamically loaded libraries -- are designed to defer loading of the library until it is needed during runtime execution. It also allows the library to be unloaded from memory when it is no longer needed by the application. Both static and shared libraries can be used as dynamically loaded libraries. They are not really a different kind of library format. The difference is in how the libraries are used by programmers. Dynamically loaded libraries require slightly more effort by the application developer to use and many programs don't need the flexibility they offer.

\subsubsection{Why is ESMF using shared object libraries?} 

ESMF must support many applications that run on a variety of platforms and written in multiple languages. For programmers who are developing libraries, shared libraries are the recommended format.  

The use of shared object libraries:
\begin{itemize}
\item simplifies the process of compiling and linking mixed C/C++ and F90 source code on multiple compiler/platform combinations. 
\item allows library upgrades to be distributed and installed separately from the applications that use them. 
\item increases program modularity and can make it easier to manage the evolution of large applications.
\item shortens the time required to recompile applications.
\end{itemize}

\subsubsection{Can I mix shared object libraries with other types of libraries?}

In short yes. But, there are a few things to keep in mind when including them in your application:

Static vs Dynamic - If there are two copies of a library, one static and one shared, the default behavior is to prefer the shared library. Before looking for static library like \emph{'libutil.a'}, the linker will look for a file named \emph{'libutil.so'} - as a shared library. Only if it cannot find a shared library, will it look for \emph{'libutil.a'} as a static library. This behavior can be overridden using some linker flags (\emph{'-Wl,static'} with some linkers, \emph{'-Bstatic'} with other types of linkers. refer to the compiler's or the linker's manual for info about these flags). 

Link order -- the order in which the libraries are presented to the linker is important. Library routines must be called before they are defined. So, if a library \emph{'A'} uses functionality provided by library \emph{'B'}, then library \emph{'A'} must appear before library \emph{'B'} during linking. 

%[TODO:] Answer if this is a potential problem for users component code to end up loading duplicate copies of .so libraries.…(Suppose you are building two dynamic-load modules, B and C, which should share another block of code A. On Unix, you would not pass A.a to the linker for B.so and C.so; that would cause it to be included twice, so that B and C would each have their own copy.)

\subsubsection{An example using shared object libraries.}
%[TODO:] a brief example.

Using the shared libraries provided by ESMF is handled in a manner similar to standard libraries that you have probably encountered in the past. The descriptions below show examples of how to link to the ESMF shared library \emph{'libesmf.so'} on each of the platforms currently supported by the ESMF development team. The example for each platform is using a Fortran 90 application, \emph{'myModel'}, and linking it with the ESMF shared object library, \emph{'libesmf.so'}


\noindent{Linking using the Compaq:}

\begin{verbatim}
   f90 -I.. -o myModel myModel.f ../libesmf.so
\end{verbatim}

\noindent{Linking using the SGI:} 

\begin{verbatim}
   f90 -64 -c myModel.F I.. 
   f90 -64 -o myModel myModel.o -L.. -lesmf
\end{verbatim}

\noindent{Linking using the IBM:}

\begin{verbatim}
   xlf90\_r -I.. -o myModel myModel.F -L. -L.. -lesmf -brtl -lC
\end{verbatim}

\noindent{Linking using Linux:} 
 
\begin{verbatim}
   lf95 -I.. -o myModel myModel.F ../libesmf.so
   pgf90 -I.. -o myModel myModel.F ../libesmf.so
\end{verbatim}

\noindent{Linking using the Sun:} 

\begin{verbatim}
   f90 -M.. -o myModel myModel.F ../libesmf.so
\end{verbatim}

\noindent{Linking using the Alpha:} 

\begin{verbatim}
   f90 myModel.F -I..  -L.. -L/usr/ccs/lib/cmplrs/cc -lcxx -lesmf  -o myModel
\end{verbatim}



































