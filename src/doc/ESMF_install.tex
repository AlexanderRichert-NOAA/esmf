% $Id: ESMF_install.tex,v 1.48 2006/01/30 18:11:38 nscollins Exp $

%\section{Installing and Building the ESMF}
\subsection{ESMF Download Options}

Major releases of the ESMF software can be downloaded by following
the instructions on the 
the {\bf Downloads \& Documentation} link on the ESMF 
website, \htmladdnormallink{http://www.esmf.ucar.edu}{http://www.esmf.ucar.edu}.

The ESMF is distributed as a full source code tree.  You will need
to compile the code into the {\tt libesmf.a} library.
On some platforms a shared library, {\tt libesmf.so}, is also created.
Follow the instructions in the following sections
to build the library and link it with your application.

\subsection{Installation}
\label{InstallProcedures}

\input{ESMF_systemreq}

\subsubsection{ESMF Environment Variables}
\label{EnvironmentVariables}

The following is a full list of all environment variables which
are used by the ESMF build system.  In many cases only {\tt ESMF\_DIR}
must be set, and on Linux clusters {\tt ESMF\_COMPILER} must also be
set to select which vendor's Fortran compiler is installed.
The other variables have defaults which work for most systems.

\begin{description}

\item[ESMF\_ARCH] 

Variable that has the value of {\tt uname -s}.  For example, this will be
AIX for IBM RS6000's.  There should be no reason for the user to set 
{\tt ESMF\_ARCH} since the proper value should be determined automatically.

\item[ESMF\_BATCHQUEUE] 

Variable specifying that the ESMF tests should use an alternative batch
system for submitting jobs.  The valid values are system dependent.
Currently, only the value {\tt lsf} is valid for AIX systems which 
are using the Platform LSF (Load Sharing Facility) to schedule jobs
instead of {\tt POE}.

\item[ESMF\_BOPT] 

Build option value of {\tt g} for debug mode or {\tt O} (capital oh) for
optimized mode.  Default value is O.  See the related {\tt ESMF\_OPTLEVEL}
entry.

\item[ESMF\_COMM] 

Defines which MPI communications library to use.  Many larger machines
will come with a vendor-supplied  MPI library and in those cases the
default setting will be the native MPI.  Otherwise the default setting will
be {\tt mpiuni} so that the mpi stub bypass library will be used.  
With this library ESMF programs can be executed but only single process.
This is the default case for Linux and Darwin systems.  
To run multiprocess an MPI implementation must be installed, and this
variable indicates which one it is.  Generally, the value will be either
{\tt mpich} or {\tt lam}.

\item[ESMF\_COMPILER]

Variable specifying which compiler to use.  Value can be default,
absoft, g95, intel, lahey, nag, pgi, or xlf.  If the value is default 
or {\tt ESMF\_COMPILER} is left unset, then the default compiler will be
used. On systems which usually come with a single vendor-supplied
compiler, the default is to use this compiler.  On systems like
Linux clusters where there is no single vendor compiler installed
on all systems, you will generally want to set this.
The default for Linux systems is lahey and on Darwin (Mac OS X)
systems it is absoft.

\item[ESMF\_C\_COMPILER]

Variable specifying which C/C++ compiler to use.   In most cases
this should not be set; the default is to use the vendor-supplied
compilers on those systems which normally come with a single
development environment; for Fortran compilers which do not normally
come with a companion C++ compiler, the default is to use the GNU C compilers.
However, some Fortran compilers support linking with either their
own C++ compiler or code compiled with the GNU compilers; 
in these cases, you can set this variable
to the value gnu in order to compile with the vendor Fortran
compiler and the GNU C/C++.   This option is only supported for
ESMF\_ARCH=Darwin, ESMF\_COMPILER=xlf, and ESMF\_ARCH=Linux,
ESMF\_COMPILER=intel.

\item[ESMF\_C\_LIBRARY]

Variable specifying which C/C++ libraries to link with.  In most cases
this should not be set; the default is to use the vendor-supplied
libraries on those systems which normally come with a single
development environment; on other systems like Linux clusters,
the default is to use the ESMF\_COMPILER setting.  However, some
vendor compilers support compiling with their compilers but linking
with the GNU C/C++ libraries.
In these cases, you can set this variable
to the value gnu in order to link with the GNU C/C++ libraries.
This option is only supported for ESMF\_ARCH=Linux, ESMF\_COMPILER=intel.

\item[ESMF\_EXHAUSTIVE] 

Variable specifying how to compile the unit tests.
If set to the value ON, then all unit tests will be compiled
and will be executed when the test is run.  If unset or set 
to any other value, only a subset of the unit tests will 
be included to verify basic functions.  Note that this
is a compile-time selection, not a run-time option.

\item[ESMF\_NO\_IOCODE] 

This version of the framework is prepared to use the {\tt netCDF} I/O
library.  However, because the location of the library and include files
varies widely from system to system the support for I/O is disabled by
default.  To enable support, edit build/common.mk and comment out the two
lines which set ESMF\_NO\_IOCODE to ON and set the CPP flag, and recompile.

\item[ESMF\_PREC] 

Variable specifying the size of an address on systems which can build
either 32 or 64 bit executables.  When possible the default value will be
64, otherwise it will be 32.

\item[ESMF\_PTHREADS]

This compile-time option controls ESMF's dependency on a functioning
Pthreads library. The default option is set to {\tt ON}. Setting this
variable to {\tt OFF} will turn ESMF's pthreads feature set off and a
stubs header file will be used instead of the Pthreads header during
library compilation. This may be necessary on systems that do not
supply a working Pthreads implementation. It may also be desirable to
disable ESMF's pthreads features for purpose of debugging ESMF
applications. Linking an ESMF application against a pthreads-disabled
ESMF library will result in run-time ESMF errors if the application
makes use of any ESMF pthreads features. The features offered by a
pthreads-enabled ESMF library form a proper superset of the
pthreads-disabled version. Specifically, a pthreads-disabled ESMF
library does not support ESMF multi-threading and concurrent execution
of components with overlapping PET lists. It also limits the
communication API as well as place some restrictions on {\em where}
Components may be created. See the VM section of the reference
document for more details on Pthreads in ESMF. (Notice that on some
platforms even a pthreads-{\em disabled} version of the ESMF library
will need to be linked against a functioning Pthreads library. In
those cases this dependency originates from the used compiler or the
MPI implementation.)

\item[ESMF\_SITE] 
Build configure file site name or the value default.  
If not set, then the value of default is assumed.
When including platform-specific files, this value is used as the
third part of the directory name (parts 1 and 2 are the
ESMF\_ARCH value and ESMF\_COMPILER value, respectively.)

\item[ESMF\_TESTWITHTHREADS]

If this environment variable is set to {\tt ON} {\em before} the ESMF system tests are build they will activate ESMF threading in their code. Specifically each component will be executed using ESMF single threading instead of the default non-threaded mode. The difference between non-threaded and ESMF single threaded execution should be completely transparent. Notice that the setting of {\tt ESMF\_TESTWITHTHREADS} does {\em not} alter ESMF's dependency on Pthreads but tests ESMF threading features during the system tests. An ESMF library that was compiled with disabled Pthread features (via the {\tt ESMF\_PTHREADS} variable) will produce ESMF error messages during system test execution if the system tests were compiled with {\tt ESMF\_TESTWITHTHREADS} set to {\tt ON}.

\end{description}

On Alpha machines an additional environment variable needs
to be set:

\begin{quote}
\begin{description}
  \item[ESMF\_PROJECT] Load Sharing Facility (LSF) project name
\end{description}
\end{quote}

On an Alpha machine, test and demo applications are run using 
the bsub command.  The value of ESMF\_PROJECT is used as the 
argument for bsub's -P option. The -P option assigns a job to 
a specific project.  

Environment variables must be set in the user's shell and not
inside an ESMF makefile or build system file.  Here is an example 
of setting an environment variable in tcsh and csh shells:

\begin{verbatim}
  setenv ESMF_PREC 32
\end{verbatim}

In ksh shell environment variables are set this way:

\begin{verbatim}
  export ESMF_PREC=32
\end{verbatim}

Environment variables can also be set from the gmake command line:

\begin{verbatim}
  gmake ESMF_PREC=32
\end{verbatim}

\subsubsection{Supported Platforms}
\input{../../build/doc/user_arch}

Building the library for multiple architectures or options at the same
time is supported; building or running the tests or examples is restricted
to one platform/architecture at a time.  The output from the test cases
will be stored in a separate directories so the results will be kept 
separate for different architectures or options.

\subsubsection{Building the ESMF Libraries}
\label{BuildESMF}

% GNU make requirement.  File in build/doc
\input{../../build/doc/user_make}

Build the library with the command:
\begin{verbatim}
  gmake 
\end{verbatim}

%Build options that enable you to copy the library and *.mod files to
%specified directories are explained in Section~\ref{BuildOptions}. 

Makefiles throughout the framework are configured to allow users to
compile files only in the directory where {\tt gmake} is entered. Shared
libraries are rebuilt only if necessary. In addition the entire ESMF
framework may be built from any directory by entering {\tt gmake all},
assuming that all the environmental variables are set correctly as
described in Section~\ref{EnvironmentVariables}.

Users may also run examples or execute unit tests of specific classes
by changing directories to the desired class {\tt examples} or {\tt tests} 
directories and entering {\tt gmake run\_examples} or 
{\tt gmake run\_unit\_tests}, respectively.  For non-multiprocessor machines,
uni-processor targets are available as {\tt gmake run\_examples\_uni} or
{\tt gmake run\_unit\_tests\_uni}.

\subsubsection{Building the ESMF Documentation}
\label{BuildDocumentation}

The documentation consists of an {\it ESMF User's Guide}, 
{\it ESMF Requirements Document}, and 
{\it ESMF Reference Manual for Fortran}.  
\noindent To build documentation:
\begin{verbatim}
  gmake doc              ! Builds the manuals, including pdf and html.
\end{verbatim}

\noindent The resulting documentation files will be
located in the top level directory \${ESMF\_DIR}/doc.

%%
%% nsc 22jun04 - this is no longer true, so i'm commenting it out for now.
%% when we make it work again, comment this section back in and update it.
%% 
%% \noindent To build documentation for one module:
%% 
%% \noindent First change directory to the where the desired module's documentation 
%% resides; for example, to build the {\tt TimeMgr} documentation start
%% with:
%% 
%% \begin{verbatim}
%% cd $ESMF_DIR/src/Infrastructure/TimeMgr/doc
%% \end{verbatim}
%% 
%% \noindent Next issue one of the following commands:
%% \begin{verbatim}
%%   gmake pdf      ! Builds local pdf files.
%%   gmake html     ! Builds local html files.
%%   gmake alldoc   ! Builds all of the local documents.
%% \end{verbatim}
%% 
%% \noindent The output from this local documentation build is in the top 
%% level {\tt doc} directory, as with the previous commands.
%% 
%% 


