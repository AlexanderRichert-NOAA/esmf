% $Id: ESMF_install.tex,v 1.16 2003/03/20 20:00:49 btwomack Exp $

\section{Installation}
\label{Installation}

\subsection{Procedures}
\label{InstallProcedures}

Currently the following environment variables need to be set:
\begin{verbatim}
  ESMF_DIR      top-level ESMF directory
  ESMF_ARCH     platform and compiler configuration
\end{verbatim}

% List of architectures supported. File in 
% build/doc.
\input{user_arch.tex}


% GNU make requirement.  File in build/doc
\input{user_make.tex}

Simultaneous multiple architecture builds are supported, with
one restriction; the test cases may only be run on one platform at a time. 

\subsubsection{Building the ESMF Library}
\label{BuildESMF}

Build the library with the command:
\begin{verbatim}
  gmake BOPT=g  
\end{verbatim}
  for a debug version or
\begin{verbatim}
  gmake BOPT=O  
\end{verbatim}
  for an optimized version.

\subsubsection{Building the ESMF Test Suites}
\label{BuildTestSuite}
A test suite is included with the library. Tests are provided for both MPI
and uniprocessor builds. Tests can be built both from the top ESMF directory and
the local source code directories.

\noindent The following command builds the System Tests:
\begin{verbatim}
  gmake BOPT=<g,O> [SYSTEM_TEST=NNNNN] build_system_tests
\end{verbatim}

For example:
\begin{verbatim}
  gmake BOPT=O build_system_tests
\end{verbatim}
Will build all available system tests. Specifying a specific SYSTEM\_TEST number will build only the specified system test.

\noindent The following command builds the Unit Tests:
\begin{verbatim}
  gmake BOPT=<g,O> [ESMF_EXHAUSTIVE=<ON,OFF>] build_tests
\end{verbatim}

For example:
\begin{verbatim}
  gmake BOPT=g ESMF_EXHAUSTIVE=OFF build_tests
\end{verbatim}
will build tests that verify basic correctness of the library build and installation. Turning the {\tt ESMF\_EXHAUSIVE} option {\tt ON} when building will create a more comprehensive set of tests, but, will take significantly longer to run. 

Output files from the test examples will be directed to files in:
\begin{verbatim}
  ${ESMF_DIR}/test${BOPT}/${ESMF_ARCH}
\end{verbatim}

See Section~\ref{TestingProcedures} for instruction on running ESMF tests.

\subsubsection{Building the ESMF Documentation}
\label{BuildDocumentation}

\noindent To build documentation:
\begin{verbatim}
  gmake dvi           ! Makes the dvi files.
  gmake pdf           ! Makes the pdf files.
  gmake html          ! Creates the html directory.
  gmake alldoc        ! Builds all the above documents.
\end{verbatim}

\noindent To build documentation for one module:

\noindent First change directory to the where the desired module's documentation resides;  for
example, to build the {\tt TimeMgmt} documentation start with:

\begin{verbatim}
cd ${ESMF_DIR}/src/Infrastructure/TimeMgmt/doc
\end{verbatim}

\noindent Next issue one of the following commands:
\begin{verbatim}
  gmake localdvi      ! Builds local dvi files.
  gmake localpdf      ! Builds local pdf files.
  gmake localhtml     ! Builds local html files.
  gmake localdoc      ! Builds all of the local documents.
\end{verbatim}

\noindent The output from this local documentation build is in the top level {\tt doc}
directory, as with the previous commands.

\subsubsection{Using the ESMF library}
\label{UsingLibrary}
To use the library from C/C++, link with the library executable and include
the {\tt ``ESMC.h''} file.
To use the library from Fortran, link with the library executable and
create links to the library modules in your build directory.  These are
in the top level {\tt mod} directory under the appropriate architecture.  Alternately, 
most compilers have a module-include-path directive which may be used to point
to the correct module directory.
To include the library in application modules, {\tt USE} the
module, e.g. {\tt ESMF\_TimeMgmtMod}.  

There is an install target which will copy the library and mod files to an
install location.  To invoke this target use:
\begin{verbatim}
  gmake BOPT=[O,g] ESMF_LIB_INSTALL=dir_for_lib ESMF_MOD_INSTALL=dir_for_mod_files install 
\end{verbatim}

Some users may wish for the library to be built in a directory different from 
where the source code resides.  To do this, build using:
\begin{verbatim}
   gmake ESMF_BUILD=build_directory_here BOPT=[O,g]
\end{verbatim}

The {\tt ESMF\_BUILD} variable gives an alternate path in which to place the libraries,
mod files and object files.  This variable defaults to {\tt ESMF\_DIR}.  If it is 
assigned another value, the {\tt ESMF\_BUILD} variable will need to be passed as
an additional argument to the the above make commands.  (Alternatively the variable
{\tt ESMF\_BUILD} can be set in the environment (using setenv or export) and then it 
need not be passed to any make calls).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  Make System
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Make System}
For most users the description of the build above should be sufficient.  Some
users, however, may wish to have a more detailed knowledge of the make system
that is used by the library either for configuring different build options or
other reasons.
\subsubsection{General Structure}
The main components of the make system are:
\begin{itemize}
\item{Build directories}

The {\tt build} directory contains some generic makefiles that are included by
the Makefiles in the source tree.  In addition, for each supported
configuration there is a directory which contains the makefiles defining
compilers, compiler flags, and the various other defintions that are necessary
to make each configuration work.  Examples include {\tt build/IRIX64,
build/rs6000\_sp, ...}

\item{Top level Makefile}

All of the make targets described installation directions above originate in
this Makefile.  This makefile includes the common makefiles from the {\tt
build} directory.  Many of the commands in this Makefile spawn a recursive make
through the directory structure.

\item{Source tree Makefiles}

Each directory contains a Makefile which includes the {\tt build} common
makefiles.  These local Makefiles include defintions that allow the local files
and documents to be built.
\end{itemize}

\subsubsection{Configuration}

Each configuration is defined in the {\tt build/ESMF\_ARCH} directory.  There
are several files in each configuration that may be hand edited to modify the
build:

\begin{itemize}

\item{{\tt base.site}}

This file contains variables which define the location of includes and
libraries such as MPI, openMP, BLAS, PCL, etc...

\item{{\tt base\_variables}}

Contains the basic definitions for compilers and compiler flags.

\item{{\tt conf.h}}

Lists compiler defines that are used to enable/disable certain options at
compiler time.  Examples include pthreads, omp, fortran\_underscore...

\end{itemize}
