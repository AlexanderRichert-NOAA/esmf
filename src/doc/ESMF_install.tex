% $Id: ESMF_install.tex,v 1.10 2002/01/28 19:29:59 dneckels Exp $

\section{Installation}

Currently the following environment variables need to be set:
\begin{verbatim}
  ESMF_DIR      top-level ESMF directory
  ESMF_ARCH     platform and compiler configuration
\end{verbatim}

\noindent The following configurations are supported:

\begin{tabular}{lll}
{\tt ESMF\_ARCH}  & {\tt alpha}      &  OSF1, Native compilers. \\
                  & {\tt IRIX64}     &  IRIX64, MIPSpro/mpt 64 bit compilers. \\
                  & {\tt IRIX}       &  IRIX64, MIPSpro/mpt n32 abi compilers. \\
                  & {\tt rs6000\_sp}  &  AIX, mpxlf90\_r, mpcc\_r, and mpCC\_r.  \\
                  & {\tt linux\_gnupgf90} & Linux, pgf90, gcc and g++.  \\
                  & {\tt linux\_pgi}  &  Linux, pgf90, pgcc, pgCC. \\
                  & {\tt linux\_lf95} &  Linux, lf95, gcc, g++. \\
                  & {\tt solaris}        &  SunOs, SUNWspro compilers. \\
                  & {\tt solaris\_hpc}   &  SunOs, SUNWhpc compilers. \\
\end{tabular}

\smallskip

The library requires {\tt gmake} to build.  Simultaneous multiple architecture builds are supported, with
one restriction; the test cases may only be run on one platform at a time. 

\smallskip

\noindent Build the library with the command:
\begin{verbatim}
  gmake BOPT=g  
\end{verbatim}
  for a debug version or
\begin{verbatim}
  gmake BOPT=O  
\end{verbatim}
  for an optimized version.

A test suite is included with the library.  Tests are provided for both MPI
and uniprocessor builds. 

\noindent To build and run MPI C tests:

\begin{verbatim}
  gmake BOPT=g test_c
\end{verbatim}

\noindent To build and run MPI F90 tests:
\begin{verbatim}
  gmake BOPT=g test_f90
\end{verbatim}

\noindent To build and run non-MPI C tests:
\begin{verbatim}
  gmake BOPT=g test_cuni
\end{verbatim}

\noindent To build and run non-MPI F90 tests:
\begin{verbatim}
  gmake BOPT=g test_f90uni
\end{verbatim}

Output files from the test examples will be directed to files in:
\begin{verbatim}
${ESMF_DIR}/test${BOPT}/${ESMF_ARCH}
\end{verbatim}

Exhaustive tests exist that may be activated by setting the environment variable
{\tt ESMF\_EXHTEST} to {\tt on}.  While this activation will test the library more thoroughly,
it will take significantly longer to complete than the basic tests.

\smallskip

\noindent To build documentation:
\begin{verbatim}
  gmake dvi           ! Makes the dvi files.
  gmake pdf           ! Makes the pdf files.
  gmake html          ! Creates the html directory.
  gmake alldoc        ! Builds all the above documents.
\end{verbatim}

\noindent To build documentation for one module:

\noindent First change directory to the where the desired module's documentation resides;  for
example, to build the {\tt TimeMgmt} documentation start with:

\begin{verbatim}
cd ${ESMF_DIR}/src/Infrastructure/TimeMgmt/doc
\end{verbatim}

\noindent Next issue on of the following commands:
\begin{verbatim}
  gmake localdvi      ! Builds local dvi files.
  gmake localpdf      ! Builds local pdf files.
  gmake localhtml     ! Builds local html files.
  gmake localdoc      ! Builds all of the local documents.
\end{verbatim}

\noindent The output from this local documentation build is in the top level {\tt doc}
directory, as with the previous commands.

\smallskip

To use the library from C/C++, link with the library executable and include
the {\tt ``ESMC.h''} file.
To use the library from Fortran, link with the library executable and
create links to the library modules in your build directory.  These are
in the top level {\tt mod} directory under the appropriate architecture.  Alternately, 
most compilers have a module-include-path directive which may be used to point
to the correct module directory.
To include the library in application modules, {\tt USE} the
module, e.g. {\tt ESMF\_TimeMgmtMod}.  

There is an install target which will copy the library and mod files to an
install location.  To invoke this target use:
\begin{verbatim}
  gmake BOPT=[O,g] ESMF_LIB_INSTALL=dir_for_lib ESMF_MOD_INSTALL=dir_for_mod_files install 
\end{verbatim}

Some users may wish for the library to be built in a directory different from 
where the source code resides.  To do this, build using:
\begin{verbatim}
   gmake ESMF_BUILD=build_directory_here BOPT=[O,g]
\end{verbatim}

The {\tt ESMF\_BUILD} variable gives an alternate path in which to place the libraries,
mod files and object files.  This variable defaults to {\tt ESMF\_DIR}.  If it is 
assigned another value, the {\tt ESMF\_BUILD} variable will need to be passed as
an additional argument to the the above make commands.  (Alternatively the variable
{\tt ESMF\_BUILD} can be set in the environment (using setenv or export) and then it 
need not be passed to any make calls).

\subsection{Make System}
For most users the description of the build above should be sufficient.  Some
users, however, may wish to have a more detailed knowledge of the make system
that is used by the library either for configuring different build options or
other reasons.
\subsubsection{General Structure}
The main components of the make system are:
\begin{itemize}
\item{Build directories}

The {\tt build} directory contains some generic makefiles that are included by
the Makefiles in the source tree.  In addition, for each supported
configuration there is a directory which contains the makefiles defining
compilers, compiler flags, and the various other defintions that are necessary
to make each configuration work.  Examples include {\tt build/IRIX64,
build/rs6000\_sp, ...}

\item{Top level Makefile}

All of the make targets described installation directions above originate in
this Makefile.  This makefile includes the common makefiles from the {\tt
build} directory.  Many of the commands in this Makefile spawn a recursive make
through the directory structure.

\item{Source tree Makefiles}

Each directory contains a Makefile which includes the {\tt build} common
makefiles.  These local Makefiles include defintions that allow the local files
and documents to be built.
\end{itemize}

\subsubsection{Configuration}

Each configuration is defined in the {\tt build/ESMF\_ARCH} directory.  There
are several files in each configuration that may be hand edited to modify the
build:

\begin{itemize}

\item{{\tt base.site}}

This file contains variables which define the location of includes and
libraries such as MPI, openMP, BLAS, PCL, etc...

\item{{\tt base\_variables}}

Contains the basic definitions for compilers and compiler flags.

\item{{\tt conf.h}}

Lists compiler defines that are used to enable/disable certain options at
compiler time.  Examples include pthreads, omp, fortran\_underscore...

\end{itemize}
