% $Id: XGrid_desc.tex,v 1.7 2012/03/27 18:43:32 feiliu Exp $

An exchange grid represents the 2D boundary layer usually between the
atmosphere on one side and ocean and land on the other in an Earth
system model. There are dynamical and thermodynamical processes on
either side of the boundary layer and on the boundary layer itself.
The boundary layer exchanges fluxes from either side and adjusts
boundary conditions for the model components involved. For climate modeling,
it is critical that the fluxes transferred by the boundary layer are
conservative.

The exchange grid is implemented as a collection of the intersected cells
between atmosphere and ocean/land\cite{BalajiXGrid}. These cells can have irregular shapes
and can be broken down into triangles facilitating a finite element
approach. In practice, there is a threshold of minimum cell area below
which intersections are discarded.

The ESMF exchange grid is implemented as the {\tt ESMF\_XGrid} class. 
An {\tt ESMF\_XGrid} object can be created either online or offline from
user supplied information. Online creation of {\tt ESMF\_XGrid} takes
two lists of {\tt ESMF\_Grid} that represent the model component grids on
either side of the exchange grid. From the two lists of {\tt ESMF\_Grid},
information required for flux exchange calculation between any pair of the 
model components from either side of the exchange grid is computed. A later
call to {\tt ESMF\_FieldRegridStore()} with the xgrid and source and destination
{\tt ESMF\_Field}s computes the {\tt ESMF\_Routehandle} object for matrix
multiply operation used in model remapping.

The {\tt ESMF\_XGrid} deals with 2 distinctive kinds of fraction for each Grid cell
involved in its creation. The first fraction quantity $f_1$ is the same as defined in direct
Field regrid between a source and destination {\tt ESMF\_Field} pair, namely the fraction
of a total Grid cell area $A$ that is used in weight generation. The second fraction quantity $f_2$
is a result of the Grid merging process when multiple {\tt ESMF\_Grid}s or model components
exist on one side of the exchange grid. To compute XGrid, the multiple {\tt ESMF\_Grid}s
are first merged together to form a super mesh. During the merging process, Grids that are
of a higher priority clips into lower priority Grids, creating fractional cells in the lower
priority Grids. Priority is a mechanism to resolve the claim of a surface region by multiple
Grids. To conserve flux, any surface area can only be claimed by a unique Grid. This is
a typical practice in earth system modelling, e.g. to handle land and ocean boundary.

In addition to the matrix multiply communication routehandle, 
{\tt ESMF\_XGrid} exports both $f_1$ and $f_2$ to the user through the {\tt ESMF\_FieldRegridStore()} method
because each remapping pair has different $f_1$ and $f_2$ associated with it. $f_2$ from source Grid is 
folded directly in the calculated weight matrices since its used to calculate destination point flux
density $F$. The global source flux is defined as $\sum_{g=1}^{g=n\_srcgrid}\sum_{s=1}^{s=n\_srccell}{ f_{1s} f_{2s} A_s F_s }$.
The global destination flux is defined as: 
$\sum_{g=1}^{g=n\_dstgrid}\sum_{d=1}^{d=n\_dstcell}{ \sum_{s=1}^{s=n\_intersect}(w_{sd} F_s) f_{2d} A_d}$, $w_{sd}$ is the
$f_2$ modified weight intersecting s-th source Grid cell with d-th destination Grid cell.
It can be proved that this formulation of the fractions and 
weight calculation ensures first order global conservation of
flux $\mathcal{F}$ transfered from source grids to exchange grid, and from exchange grid to destination grids.

In the offline mode, the user is required to supply all necessary information to 
compute communiction routehandle.

