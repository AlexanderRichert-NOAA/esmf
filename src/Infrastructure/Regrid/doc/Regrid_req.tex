% $Id: Regrid_req.tex,v 1.5 2002/03/26 00:34:34 pwjones Exp $

%===============================================================================
% Requirements may be itemized under a main topic:
%===============================================================================
%===============================================================================
\req{General Regridding Requirements}
%-------------------------------------------------------------------------------

The following are general requirements for regridding operations and are in
addition to the applicable general ESMF requirements.

%-------------------------------------------------------------------------------
\sreq{Creation}

Applications must be able to create a regridding and initialize
various time-independent regridding quantities.

\begin{reqlist}
{\bf Priority:} 1 \\
{\bf Source:} All codes will require this. \\
{\bf Status:} Proposed \\
{\bf Verification:} Unit test \\
{\bf Notes:} This function will, in many cases, be computing
             regridding weights and initializing various
             communication information for performing regridding.
\end{reqlist}

%-------------------------------------------------------------------------------
\sreq{Destruction}

Applications must be able to destroy regriddings to free up memory.

\begin{reqlist}
{\bf Priority:} 1 \\
{\bf Source:} POP, CICE, CAM desired \\
{\bf Status:} Proposed \\
{\bf Verification:} Unit test \\
{\bf Notes:} 
\end{reqlist}

%-------------------------------------------------------------------------------
\sreq{Reading}

Applications may be able to read regridding information from a file.

\begin{reqlist}
{\bf Priority:} 2 \\
{\bf Source:} POP, CICE, CAM desired \\
{\bf Status:} Proposed \\
{\bf Verification:} Unit test \\
{\bf Notes:} Useful if creating regriddings is time-consuming to avoid
             start-up costs.
\end{reqlist}

%-------------------------------------------------------------------------------
\sreq{Writing}

Applications may be able to write regridding information to a file.

\begin{reqlist}
{\bf Priority:} 2 \\
{\bf Source:} POP, CICE, CAM desired \\
{\bf Status:} Proposed \\
{\bf Verification:} Unit test \\
{\bf Notes:} Useful if creating regriddings is time-consuming - compute once
             and save for later re-use.  Also useful for any off-line
             use of same regridding info.
\end{reqlist}

%-------------------------------------------------------------------------------
\sreq{Support for ESMF Grids}

Regridding operations must be available for all supported ESMF grids,
including ungridded data.

\begin{reqlist}
{\bf Priority:} 1 \\
{\bf Source:} All codes require this. \\
{\bf Status:} Proposed \\
{\bf Verification:} System test \\
{\bf Notes:} Not all regridding operations are appropriate for all
             grid types.
\end{reqlist}

%-------------------------------------------------------------------------------
\sreq{Multiple fields}

Regridding of multiple fields (bundles of fields) with
a single call must be supported.

\begin{reqlist}
{\bf Priority:} 2-3? \\
{\bf Source:} POP, CICE, CAM desired \\
{\bf Status:} Proposed \\
{\bf Verification:} Unit test \\
{\bf Notes:} This should be supplied for efficiency, but may not
             be required to achieve functionality.
\end{reqlist}

%-------------------------------------------------------------------------------
\sreq{Consistency of coordinates}

Regridding will assume source and destination grids will be
in compatible coordinate systems.  This also applies to vertical
grid systems.
That is, no knowledge of units or physics must be necessary
to perform regridding.

\begin{reqlist}
{\bf Priority:} 1 \\
{\bf Source:} Required by all. \\
{\bf Status:} Proposed \\
{\bf Verification:} Code inspection  \\
{\bf Notes:} A horizontal grid pair must be either both in x-y units (m) 
             with the same origin or both in lat-lon (deg) units unless 
             we decide to include arbitrary projection information as part 
             of a PhysGrid structure. 
             Also, vertical regridding between all possible vertical grid 
             systems is problematic.
             \\
            
\end{reqlist}

%-------------------------------------------------------------------------------
\sreq{Independence of field}

At least one regridding method must be completely independent of
field information.  Whenever possible, regridding should be formulated to be 
independent of the field being regridded.  For regridding schemes which might 
require field information (eg gradients of the field or a velocity for 
upwind regridding), the required field information must be passed as arguments.

\begin{reqlist}
{\bf Priority:} 1 \\
{\bf Source:} Required by all. \\
{\bf Status:} Proposed \\
{\bf Verification:} Code inspection  \\
{\bf Notes:} If a way of passing user-defined functions
             were available, this requirement could be relaxed substantially.
\end{reqlist}

%===============================================================================
\req{Regridding algorithms}
%-------------------------------------------------------------------------------

This section contains requirements on regridding algorithms themselves.

%-------------------------------------------------------------------------------
\sreq{Conservation}

At least one regridding method between two gridded fields must be
\htmlref{conservative}{glos:conservation}.

\begin{reqlist}
{\bf Priority:} 1 \\
{\bf Source:} POP,CICE,CAM required \\
{\bf Status:} Proposed \\
{\bf Verification:} Unit test \\
{\bf Notes:} The methods of Jones (1999, \cite{Jones1999}) can be used
             for 2-d fields. A Monte Carlo method could be used for
             3-d fields.  Conservation has no meaning
             for ESMF grids without an area or volume attribute
             (eg ungridded data, spectral-space grids), so this
             requirement does not apply to such grids.

             MI - Some grids may have a higher-order integration method
             associated with them (overlappping functions as weights),
             potentially making conservative regridding difficult and expensive.
             PJ - Second order conservative is part of SCRIP currently,
             but is expensive (3x 1st-order); higher than second order is not 
             feasible at this time for conservative schemes.
             \\
\end{reqlist}

%-------------------------------------------------------------------------------
\sreq{Monotonicity}

At least one regridding method must be \htmlref{monotone}{glos:monotone}.

\begin{reqlist}
{\bf Priority:} 2-3? \\
{\bf Source:}  \\
{\bf Status:} Proposed \\
{\bf Verification:} Unit test \\
{\bf Notes:} Biogeochemical models may need this.  First-order
             conservative schemes are generally monotone by
             construction, so this could be satisfied by the
             conservation requirement for gridded data.
\end{reqlist}


%-------------------------------------------------------------------------------
\sreq{Higher-order schemes}

At least one regridding method must be higher than first
\htmlref{order}{glos:order}.  This is required for preventing
``patchwork'' patterns when regridding from coarse to fine
grids and for preventing discontinuities in gradients of
regridded fields.

\begin{reqlist}
{\bf Priority:} 1 \\
{\bf Source:}  POP, CICE, CAM required. \\
{\bf Status:} Proposed \\
{\bf Verification:} Unit test \\
{\bf Notes:} This will require either internal approximations to
             gradients (eg bilinear, bicubic) or will require user
             to pass gradient information (eg second-order conservative 
             methods).  See requirements on field dependence.
\end{reqlist}

%-------------------------------------------------------------------------------
\sreq{Vector fields in physical space}

At least one regridding method must be available for regridding a horizontal
vector field with components aligned with physical directions 
(eg zonal-meridional or x-y), where the physical direction may be
inferred by the grid type or specified by user.

\begin{reqlist}
{\bf Priority:} 1 \\
{\bf Source:}  POP, CICE, CAM required. \\
{\bf Status:} Proposed \\
{\bf Verification:} Unit test \\
{\bf Notes:} 
\end{reqlist}

%-------------------------------------------------------------------------------
\sreq{Vector fields in logical space}

At least one regridding method must be available for regridding a horizontal
vector field with components aligned along grid logical directions.
Logical directions here refer to directions parallel and perpendicular
to cell sides.

\begin{reqlist}
{\bf Priority:}  \\
{\bf Source:}  POP, CICE, CAM desired. \\
{\bf Status:} Proposed \\
{\bf Verification:} Unit test \\
{\bf Notes:} Currently working on whether it is even possible to do this
             in all cases, but willing to make the attempt.
\end{reqlist}

%-------------------------------------------------------------------------------
\sreq{Fourier transforms}

Methods shall be supplied for regridding between physical space and
Fourier space.  The adjoints shall also be supplied.  Ordering in
Fourier space will be defined by DistGrid.

\begin{reqlist}
{\bf Priority:} 1 \\
{\bf Source:}  NCEP-GSM, NCEP-SSI (milestone) \\
{\bf Status:} Proposed \\
{\bf Verification:} Unit test \\
{\bf Notes:} 
\end{reqlist}

%-------------------------------------------------------------------------------
\sreq{Legendre transforms}

Methods shall be supplied for regridding between spectral space and
Fourier space.  The adjoints shall also be supplied.

\begin{reqlist}
{\bf Priority:} 1 \\
{\bf Source:}  NCEP-GSM, NCEP-SSI (milestone) \\
{\bf Status:} Proposed \\
{\bf Verification:} Unit test \\
{\bf Notes:} see notes under Fourier transforms
\end{reqlist}

%-------------------------------------------------------------------------------
\sreq{Other functional transforms}

Methods shall be supplied for regridding using user-supplied matrices,
particularly between functional space and physical space.
The adjoints shall also be supplied.

\begin{reqlist}
{\bf Priority:} 1 \\
{\bf Source:}  NCEP-SSI (milestone) \\
{\bf Status:} Proposed \\
{\bf Verification:} Unit test \\
{\bf Notes:} MI - The NCEP-SSI transforms between vertical EOF space
             and vertical model levels.
\end{reqlist}

%-------------------------------------------------------------------------------
\sreq{Interpolating with ungridded data}

All methods shall work with for regridding FROM gridded data TO ungridded 
data, except that no conservation properties are required.
Methods for regridding FROM ungridded data TO gridded data may be
supplied (eg nearest-neighbor distance-weighted schemes).
The adjoints shall be supplied for interpolation TO ungridded data.

\begin{reqlist}
{\bf Priority:} 1 \\
{\bf Source:}  NCEP-SSI (milestone) \\
{\bf Status:} Proposed \\
{\bf Verification:} Unit test \\
{\bf Notes:} 
\end{reqlist}

%-------------------------------------------------------------------------------
\sreq{Interpolation adjoints}

Adjoints shall be supplied for all methods.

\begin{reqlist}
{\bf Priority:} 2 \\
{\bf Source:}  \\
{\bf Status:} Proposed \\
{\bf Verification:} Unit test \\
{\bf Notes:} MI - It would be nice to have adjoints supplied for all methods.
             However, methods where adjoints are absolutely required
             have been so noted within their own respective decriptions.
\end{reqlist}

%===============================================================================
\req{Other utilities}
%-------------------------------------------------------------------------------

The following are utilities related to regridding which should be made
public.

%-------------------------------------------------------------------------------
\sreq{Exchange grid}

A method for constructing a new grid formed by the intersecting
cells of two grids shall be available.

\begin{reqlist}
{\bf Priority:}  \\
{\bf Source:}  NSIPP \\
{\bf Status:} Proposed \\
{\bf Verification:} Unit test \\
{\bf Notes:} 
\end{reqlist}

%-------------------------------------------------------------------------------
\sreq{Grid search}

Methods must be supplied for searching a grid to find the cell(s)
containing a point (or set of points).

\begin{reqlist}
{\bf Priority:} 1 \\
{\bf Source:}  \\
{\bf Status:} Proposed \\
{\bf Verification:} Unit test \\
{\bf Notes:} This is required for some of the above functions, but
             should it be here or in one of the other grid modules?
             If it is located in another module, I (PJ) would be
             willing to supply the necessary code.
             \\
             MI - It should be in the same place as its inverse.
             That is, this requirement is
             given a physical location return the grid cell,
             while its inverse is
             given a grid cell return the physical location.
             I suggest these methods belong in Physical Grids.
\end{reqlist}

